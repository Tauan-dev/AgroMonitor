<div class="container">
  <h1>An√°lise de Planejamento Agr√≠cola</h1>

  <!-- PAR√ÇMETROS -->
  <div class="input-section">
    <h2>Par√¢metros</h2>
    <p>
      Observando os parametros de analise, temos 5% como nossa base de
      compara√ß√£o.
    </p>
    <div class="form-group">
      <label>Perturba√ß√£o Relativa (%)</label>
      <input
        type="range"
        min="0.01"
        max="0.30"
        step="0.01"
        [value]="input.rel_perturb"
        (change)="updatePerturbation($any($event.target).value)"
      />
      <span>{{ (input.rel_perturb * 100).toFixed(1) }}%</span>
    </div>

    <button (click)="analyze()" [disabled]="loading" class="btn-primary">
      {{ loading ? "Analisando..." : "Executar An√°lise" }}
    </button>
  </div>

  <!-- ERRO -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- RESULTADOS (s√≥ se houver result) -->
  <ng-container *ngIf="result as r">
    <div class="results-section">
      <h2>Resultados</h2>

      <!-- M√âTRICAS -->
      <!-- LUCRO ESTIMADO (3 CARDS SEPARADOS) -->
      <div class="metrics profits-section">
        <!-- CARD 1: LUCRO BASE -->
        <div class="metric-card profit-card profit-base">
          <h3>üí∞ Lucro Base (Cen√°rio Atual)</h3>
          <p class="value profit-value">
            {{
              r.profit_base !== undefined
                ? r.profit_base.toLocaleString("pt-BR", {
                    maximumFractionDigits: 2
                  })
                : ""
            }}
          </p>
          <p class="profit-label">Lucro com recursos atuais</p>
          <div class="profit-icon">üìä</div>
        </div>

        <!-- CARD 2: LUCRO PESSIMISTA -->
        <div class="metric-card profit-card profit-pessimistic">
          <h3>‚ö†Ô∏è Cen√°rio Pessimista</h3>
          <p class="value profit-value profit-loss">
            {{
              r.profit_pert_pessimistic !== undefined
                ? r.profit_pert_pessimistic.toLocaleString("pt-BR", {
                    maximumFractionDigits: 2
                  })
                : ""
            }}
          </p>
          <p class="profit-label">
            Redu√ß√£o de {{ (input.rel_perturb * 100).toFixed(1) }}% em recursos
          </p>
          <p class="profit-impact">
            Impacto:
            <span
              [class]="
                r.profit_pert_pessimistic < r.profit_base
                  ? 'negative'
                  : 'positive'
              "
            >
              {{
                (
                  ((r.profit_pert_pessimistic - r.profit_base) /
                    r.profit_base) *
                  100
                ).toFixed(1)
              }}%
            </span>
          </p>
        </div>

        <!-- CARD 3: LUCRO OTIMISTA -->
        <div class="metric-card profit-card profit-optimistic">
          <h3>‚úÖ Cen√°rio Otimista</h3>
          <p class="value profit-value profit-gain">
            {{
              r.profit_pert_optimistic !== undefined
                ? r.profit_pert_optimistic.toLocaleString("pt-BR", {
                    maximumFractionDigits: 2
                  })
                : ""
            }}
          </p>
          <p class="profit-label">
            Aumento de {{ (input.rel_perturb * 100).toFixed(1) }}% em recursos
          </p>
          <p class="profit-impact">
            Ganho:
            <span class="positive">
              {{
                (
                  ((r.profit_pert_optimistic - r.profit_base) / r.profit_base) *
                  100
                ).toFixed(1)
              }}%
            </span>
          </p>
        </div>
      </div>

      <!-- CARDS DE CONDICIONAMENTO E SENSIBILIDADE (COM EXPLICA√á√ïES) -->
      <div class="metrics metrics-explained">
        <!-- CARD: CONDICIONAMENTO -->
        <div class="metric-card metric-explained">
          <h3>üî¢ N√∫mero de Condi√ß√£o (Œ∫)</h3>
          <p class="value metric-value">
            {{ r.kappa !== undefined ? r.kappa.toExponential(2) : "" }}
          </p>
          <p
            class="condition-status"
            [class]="
              r.kappa < 1e2 ? 'well' : r.kappa < 1e4 ? 'moderate' : 'ill'
            "
          >
            {{
              r.kappa < 1e2
                ? "‚úì Bem Condicionado"
                : r.kappa < 1e4
                ? "‚ö† Moderado"
                : "üî¥ Mal Condicionado"
            }}
          </p>
          <div class="explanation">
            <p>
              <strong>O que √©?</strong> Mede a estabilidade num√©rica do sistema.
              Valores baixos = sistema robusto; valores altos = sistema fr√°gil.
            </p>
            <p>
              <strong>Interpreta√ß√£o:</strong>
              <span *ngIf="r.kappa < 1e2"
                >Pequenos erros em recursos causam pequenos erros nas
                solu√ß√µes.</span
              >
              <span *ngIf="r.kappa >= 1e2 && r.kappa < 1e4"
                >Erros moderados podem ser amplificados na solu√ß√£o.</span
              >
              <span *ngIf="r.kappa >= 1e4"
                >Erros pequenos podem resultar em mudan√ßas grandes e
                imprediz√≠veis.</span
              >
            </p>
          </div>
        </div>

        <!-- CARD: SENSIBILIDADE -->
        <div class="metric-card metric-explained">
          <h3>üìà Sensibilidade (||Œîx||/||x||)</h3>
          <p class="value metric-value">
            {{ r.rel_dx !== undefined ? r.rel_dx.toExponential(2) : "" }}
          </p>
          <p class="sensitivity-label">
            Mudan√ßa de 1% em recursos ‚Üí {{ (r.rel_dx * 100).toFixed(2) }}% em
            √°reas
          </p>
          <div class="explanation">
            <p>
              <strong>O que √©?</strong> Mede quanto as √°reas plantadas mudam
              quando os recursos variam 1%.
            </p>
            <p>
              <strong>Interpreta√ß√£o:</strong>
              <span *ngIf="r.rel_dx < 0.5"
                >Plano √© resiliente; mudan√ßas pequenas em insumos afetam pouco o
                plano.</span
              >
              <span *ngIf="r.rel_dx >= 0.5 && r.rel_dx < 2"
                >Plano tem sensibilidade moderada; mudan√ßas em insumos exigem
                ajustes.</span
              >
              <span *ngIf="r.rel_dx >= 2"
                >Plano √© sens√≠vel; varia√ß√µes pequenas em recursos requerem
                replaneamento frequente.</span
              >
            </p>
          </div>
        </div>
      </div>

      <!-- GR√ÅFICOS (SE√á√ÉO PROFISSIONAL) -->
      <div class="charts-container">
        <h2
          style="
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 20px 0;
            color: var(--color-text);
          "
        >
          üìä An√°lise Visual
        </h2>

        <div class="charts">
          <div class="chart">
            <h3>Mapa de Sensibilidade</h3>
            <img
              *ngIf="r.heatmap"
              [src]="'data:image/png;base64,' + r.heatmap"
              alt="Heatmap de Sensibilidade"
            />
          </div>

          <div class="chart">
            <h3>Cen√°rios de Produ√ß√£o</h3>
            <img
              *ngIf="r.comparison"
              [src]="'data:image/png;base64,' + r.comparison"
              alt="Compara√ß√£o Base vs Perturbado"
            />
          </div>

          <div class="chart">
            <h3>Estabilidade Num√©rica</h3>
            <img
              *ngIf="r.sensitivity"
              [src]="'data:image/png;base64,' + r.sensitivity"
              alt="Sensibilidade Bem vs Mal Condicionado"
            />
          </div>

          <div class="chart">
            <h3>Otimiza√ß√£o via Regulariza√ß√£o</h3>
            <img
              *ngIf="r.regularization"
              [src]="'data:image/png;base64,' + r.regularization"
              alt="Normal vs Regularizado"
            />
          </div>
        </div>
      </div>

      <!-- DIAGN√ìSTICOS -->
      <div class="diagnostics" *ngIf="r.diagnostics as d">
        <h3>Diagn√≥sticos</h3>
        <ul>
          <li>
            Œ∫(bem) =
            {{
              d.kappa_well !== undefined ? d.kappa_well.toExponential(2) : ""
            }}
          </li>
          <li>
            Œ∫(mal) =
            {{ d.kappa_ill !== undefined ? d.kappa_ill.toExponential(2) : "" }}
          </li>
          <li>
            ||Œîx||/||x|| (bem) =
            {{
              d.rel_dx_well !== undefined ? d.rel_dx_well.toExponential(2) : ""
            }}
          </li>
          <li>
            ||Œîx||/||x|| (mal) =
            {{
              d.rel_dx_ill !== undefined ? d.rel_dx_ill.toExponential(2) : ""
            }}
          </li>
        </ul>
      </div>
    </div>
  </ng-container>
  <!-- INSIGHTS INTELIGENTES (NOVA SE√á√ÉO) -->
  <ng-container *ngIf="interpretedResult as interp">
    <div class="insights-section">
      <h2>üìä Insights Inteligentes com IA</h2>

      <!-- RESUMO INTUITIVO -->
      <div class="insight-card insight-summary">
        <h3>üìù Resumo Intuitivo</h3>
        <p class="insight-text">{{ interp.summary }}</p>
      </div>

      <!-- AN√ÅLISE DE CI√äNCIA DE DADOS -->
      <div class="insight-card insight-data-science">
        <h3>üî¨ An√°lise de Ci√™ncia de Dados</h3>
        <div
          class="insight-text"
          [innerHTML]="interp.dataScienceInsight | safe"
        ></div>
      </div>

      <!-- CONTEXTO AGR√çCOLA -->
      <div class="insight-card insight-agriculture">
        <h3>üåæ Contexto Agr√≠cola</h3>
        <p class="insight-text">{{ interp.agriculturalContext }}</p>
      </div>

      <!-- DIAGN√ìSTICO PREDITIVO -->
      <div class="insight-card insight-predictive">
        <h3>üîÆ Diagn√≥stico Preditivo</h3>
        <div
          class="insight-text"
          [innerHTML]="interp.predictiveDiagnosis | safe"
        ></div>
      </div>

      <!-- RECOMENDA√á√ïES T√âCNICAS -->
      <div class="insight-card insight-recommendations">
        <h3>‚úÖ Recomenda√ß√µes T√©cnicas</h3>
        <ul class="recommendations-list">
          <li
            *ngFor="let rec of interp.recommendations"
            class="recommendation-item"
          >
            {{ rec }}
          </li>
        </ul>
      </div>

      <!-- ALERTAS DE RISCO -->
      <div
        *ngIf="interp.riskFlags.length > 0"
        class="insight-card insight-risks"
      >
        <h3>‚ö†Ô∏è Alertas de Risco</h3>
        <div class="risk-flags-container">
          <div
            *ngFor="let flag of interp.riskFlags"
            [class]="'risk-flag risk-flag-' + flag.level"
          >
            <span class="risk-icon">
              {{
                flag.level === "critical"
                  ? "üî¥"
                  : flag.level === "warning"
                  ? "‚ö†Ô∏è"
                  : "‚ÑπÔ∏è"
              }}
            </span>
            <span class="risk-message">{{ flag.message }}</span>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>
